<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MEGAMICRODAW // v5.0_UNIFIED_UI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { 
            --bg: #0f1115; 
            --panel: #16191f; 
            --surface: #21252b;
            --text: #aab2c0; 
            --accent: #3498db; 
            --accent-glow: rgba(52, 152, 219, 0.4);
            --danger: #e74c3c; 
            --rec: #ff4757; 
            --step-off: #2c313a; 
            --step-on: #3498db;
            --playhead-color: #2ecc71;
            --btn-grad-top: #3a404b;
            --btn-grad-bot: #2c313a;
        }

        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, sans-serif; text-transform: uppercase; padding: 20px; margin: 0; user-select: none; }
        
        #chassis { 
            border: 1px solid #000; 
            padding: 15px; 
            background: var(--panel); 
            max-width: 1400px; 
            margin: 0 auto; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.9), inset 0 1px 0 rgba(255,255,255,0.05); 
            border-radius: 6px;
        }

        .panel { 
            border: 1px solid #000; 
            padding: 12px; 
            margin-bottom: 10px; 
            background: var(--surface); 
            border-radius: 4px; 
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }

        .flex { display: flex; gap: 10px; align-items: center; }
        .flex-wrap { flex-wrap: wrap; }
        
        /* Control Groups */
        .ctrl-group { border-right: 1px solid #333; padding-right: 15px; margin-right: 5px; display: flex; align-items: center; gap: 15px; }
        .ctrl-group:last-child { border: none; }
        
        /* EXPANDED SLIDER BOXES */
        .mini-slider-box { display: flex; flex-direction: column; width: 110px; position: relative; top: -2px; }
        .mini-slider-box label { font-size: 9px; color: #666; margin-bottom: 4px; letter-spacing: 1px; font-weight: 600; }

        /* CUSTOM SLIDER STYLING */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; margin: 0; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #000; border-radius: 2px; border-bottom: 1px solid #333; }
        input[type=range]::-moz-range-track { width: 100%; height: 4px; background: #000; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; 
            background: #ccc; margin-top: -4px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); 
        }

        /* ----- UNIFIED PREMIUM BUTTONS ----- */
        button { 
            background: linear-gradient(to bottom, var(--btn-grad-top), var(--btn-grad-bot));
            color: #fff; 
            border: 1px solid #111; 
            border-top: 1px solid #4a5160;
            cursor: pointer; 
            padding: 8px 14px; 
            font-size: 10px; 
            font-weight: 600;
            border-radius: 3px; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
            transition: all 0.1s ease;
            letter-spacing: 0.5px;
        }
        
        button:hover { 
            background: linear-gradient(to bottom, #454d5a, #363d48);
            color: #fff;
            transform: translateY(-1px);
        }
        
        button:active { 
            transform: translateY(1px);
            background: #222;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
            border-top: 1px solid #111;
        }

        button.active { 
            background: var(--accent) !important; 
            border-color: #2980b9 !important; 
            box-shadow: 0 0 15px var(--accent-glow), inset 0 1px 0 rgba(255,255,255,0.3); 
            text-shadow: none;
        }
        
        button.armed { background: var(--rec) !important; color: #fff; animation: flash 2s infinite; }
        button.recording { background: var(--rec) !important; color: #fff; box-shadow: 0 0 15px var(--rec); border:1px solid #fff !important; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        /* GRID LAYOUTS */
        .track-row { 
            display: grid; 
            grid-template-columns: 120px 1fr 90px 40px; 
            gap: 10px; 
            margin-bottom: 5px; 
            align-items: center; 
            background: #1d2127; 
            padding: 6px; 
            border-radius: 4px; 
            border: 1px solid #000;
        }
        
        .step-grid { display: grid; grid-template-columns: repeat(32, 1fr); gap: 2px; width: 100%; }
        
        .playhead-slot { height: 4px; width: 4px; background: #333; border-radius: 50%; margin: 0 auto; transition: all 0.05s; }
        .playhead-slot.active { background: var(--playhead-color); box-shadow: 0 0 8px var(--playhead-color); transform: scale(1.5); }

        .step { height: 26px; border-radius: 2px; cursor: pointer; background: var(--step-off); transition: background 0.1s; }
        .step.on { background: var(--step-on); box-shadow: 0 0 10px var(--accent-glow); }
        .step.beat-mark { border-left: 1px solid #555; }

        /* ----- EVEN MIXER LAYOUT ----- */
        .mixer-rack { 
            display: grid; /* Changed from Flex to Grid for perfect even distribution */
            grid-template-columns: repeat(8, 1fr); /* 8 Equal columns */
            gap: 8px; 
            min-height: 400px; 
            padding: 10px; 
            background: #111; 
            border: 1px solid #000; 
            border-radius: 4px;
        }
        
        .mixer-strip { 
            width: auto; /* Remove fixed width to allow grid stretching */
            border: 1px solid #333; 
            padding: 10px; 
            background: #1a1d23; 
            border-radius: 4px; 
            display: flex; 
            flex-direction: column;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
        }
        
        .fx-stack { 
            flex-grow: 1; 
            margin: 10px 0; 
            border: 1px inset #000; 
            background: #0d0f12; 
            padding: 5px; 
            min-height: 150px; 
            overflow-y: auto; 
            border-radius: 2px;
        }
        
        .data-font { font-size: 10px; letter-spacing: 1px; color: #666; font-family: monospace; font-weight: bold; }
        
        #status-led { width: 8px; height: 8px; border-radius: 50%; background: #333; box-shadow: inset 0 1px 2px rgba(0,0,0,0.5); }
        #status-led.online { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
        
        .rec-panel { display:flex; gap:10px; align-items:center; }
        audio { height: 20px; width: 150px; }

        /* Remove default blue outline on focus for cleanliness */
        *:focus { outline: none; }
        
        /* Select styling to match buttons */
        select {
            background: #16191f;
            color: #ccc;
            border: 1px solid #000;
            padding: 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
<div id="chassis">
    <div class="panel flex flex-wrap" style="justify-content: space-between; align-items: center;">
        
        <div class="ctrl-group">
            <div id="status-led"></div>
            <button id="pBtn" onclick="engine.toggle()" style="width:60px;">START</button>
            <button id="modeBtn" onclick="ui.toggleMode()">PAT</button>
            
            <div class="mini-slider-box">
                <label>BPM: <span id="bpm-val" style="color:#ccc">120</span></label>
                <input type="range" min="60" max="200" value="120" oninput="engine.bpm=this.value; document.getElementById('bpm-val').innerText=this.value">
            </div>

            <div class="mini-slider-box">
                <label>SWING</label>
                <input type="range" min="0" max="0.3" step="0.01" value="0" oninput="engine.swing=this.value">
            </div>

            <div class="mini-slider-box">
                <label>MASTER</label>
                <input type="range" min="0" max="1.5" step="0.01" value="1" oninput="engine.setMaster(this.value)">
            </div>
        </div>

        <div class="ctrl-group rec-panel">
            <button id="armBtn" onclick="recorder.toggleArm()">ARM REC</button>
            <div id="rec-ui-hidden" style="display:none" class="flex">
                <audio id="rec-preview" controls></audio>
                <a id="rec-dl" download="resample.webm"><button>SAVE</button></a>
            </div>
        </div>

        <div class="flex">
            <button onclick="io.exportSession()">EXP</button>
            <button onclick="document.getElementById('importInput').click()">IMP</button>
            <input type="file" id="importInput" style="display:none" onchange="io.importSession(this)">
            <button id="tSeq" class="active" onclick="ui.tab('seq')">SEQ</button>
            <button id="tMix" onclick="ui.tab('mix')">MIX</button>
        </div>
    </div>

    <div id="page-seq">
        <div class="panel flex" id="bank-nav"></div>
        <div id="track-rack" class="panel">
            <div class="flex" style="margin-bottom:15px; justify-content: space-between;">
                <button onclick="engine.addTrack()">+ TRACK</button>
                <div class="flex" style="background: #111; border-radius: 3px; padding: 2px 5px; border:1px solid #000;">
                    <button onclick="engine.updateBankLength(-1)" style="padding: 2px 8px; height: 20px;">&lt;</button>
                    <span class="data-font" id="bank-len-disp" style="min-width:110px; text-align:center; line-height: 20px;">PAT 1 LEN: 16</span>
                    <button onclick="engine.updateBankLength(1)" style="padding: 2px 8px; height: 20px;">&gt;</button>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 120px 1fr 90px 40px; gap: 10px; margin-bottom:5px;">
                <div></div><div id="playhead-grid" class="step-grid"></div><div></div><div></div>
            </div>
            <div id="tracks-list"></div>
        </div>
        <div class="panel">
            <div class="data-font">SONG_ARRANGER</div>
            <div id="song-arranger-box" class="flex" style="background:#111; padding:10px; margin-top:5px; overflow-x:auto; border-radius: 3px;">
                <button onclick="engine.addSongCell()">+ ADD</button>
                <button onclick="engine.removeSongCell()">- REM</button>
                <div id="song-cells" class="flex" style="margin-left:15px"></div>
            </div>
        </div>
    </div>

    <div id="page-mix" style="display:none">
        <div id="mixer-rack" class="mixer-rack"></div>
    </div>
</div>

<script>
const recorder = {
    mediaRecorder: null, chunks: [], armed: false, recording: false, streamNode: null,
    toggleArm() {
        this.armed = !this.armed;
        const btn = document.getElementById('armBtn');
        if(this.armed) {
            btn.classList.add('armed'); btn.innerText = "WAITING...";
            document.getElementById('rec-ui-hidden').style.display = 'none';
        } else {
            btn.classList.remove('armed'); btn.classList.remove('recording'); btn.innerText = "ARM REC";
        }
    },
    start() {
        if(!this.armed) return;
        this.chunks = [];
        if (!this.streamNode) {
            this.streamNode = engine.ctx.createMediaStreamDestination();
            engine.master.connect(this.streamNode);
        }
        try { this.mediaRecorder = new MediaRecorder(this.streamNode.stream); } 
        catch(e) { alert("Rec Error: Browser not supported."); return; }
        this.mediaRecorder.ondataavailable = e => this.chunks.push(e.data);
        this.mediaRecorder.onstop = () => this.finish();
        this.mediaRecorder.start();
        this.recording = true;
        const btn = document.getElementById('armBtn');
        btn.classList.remove('armed'); btn.classList.add('recording'); btn.innerText = "REC";
    },
    stop() { if(this.recording && this.mediaRecorder) { this.mediaRecorder.stop(); this.recording = false; } },
    finish() {
        const btn = document.getElementById('armBtn');
        btn.classList.remove('recording'); btn.innerText = "ARM REC";
        this.armed = false; 
        const blob = new Blob(this.chunks, { 'type' : 'audio/webm' });
        const url = URL.createObjectURL(blob);
        document.getElementById('rec-preview').src = url;
        document.getElementById('rec-dl').href = url;
        document.getElementById('rec-ui-hidden').style.display = 'flex';
    }
};

const engine = {
    ctx: null, master: null, tracks: [], mixer: [], song: [0],
    bpm: 120, playing: false, step: 0, bank: 0, songIdx: 0, nextTime: 0, timer: null,
    bankLengths: Array(8).fill(16), swing: 0, 

    initChannels() {
        if (this.ctx) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
        this.master = this.ctx.createGain();
        this.master.connect(this.ctx.destination);
        for(let i=0; i<8; i++) {
            const input = this.ctx.createGain();
            const output = this.ctx.createGain();
            input.connect(output); output.connect(this.master);
            this.mixer.push({ input, output, fx: [] });
        }
    },
    setMaster(val) { if(this.master) this.master.gain.value = val; },
    async toggle() {
        this.initChannels();
        if (this.ctx.state === 'suspended') await this.ctx.resume();
        this.playing = !this.playing;
        if (this.playing) {
            if(recorder.armed) recorder.start();
            this.nextTime = this.ctx.currentTime;
            this.scheduler();
        } else { this.stopAll(); }
        document.getElementById('pBtn').innerText = this.playing ? "STOP" : "START";
        document.getElementById('status-led').className = this.ctx.state === 'running' ? 'online' : '';
    },
    scheduler() {
        if (!this.playing) return;
        while (this.nextTime < this.ctx.currentTime + 0.1) {
            const activeBank = ui.mode === 'song' ? this.song[this.songIdx] : this.bank;
            this.playStep(this.step, this.nextTime, activeBank);
            this.nextTime += (60 / this.bpm / 4);
            this.step++;
            if(this.step >= this.bankLengths[activeBank]) {
                this.step = 0;
                if (ui.mode === 'song') {
                    this.songIdx = (this.songIdx + 1) % this.song.length;
                    requestAnimationFrame(() => ui.render());
                }
            }
        }
        this.timer = setTimeout(() => this.scheduler(), 25);
    },
    playStep(s, t, b) {
        const swingOffset = (s % 2 !== 0) ? (this.swing * (60 / this.bpm / 4)) : 0;
        const time = t + swingOffset;
        this.tracks.forEach(tr => {
            if (tr.buffer && tr.patterns[b][s]) {
                const channel = this.mixer[tr.bus];
                channel.fx.forEach(plugin => { if (plugin.trigger) plugin.trigger(time); });
                
                // MONO TRIGGER LOGIC: Prevent overlap on same track
                if (tr.activeSource && tr.gainNode) {
                    tr.gainNode.gain.cancelAndHoldAtTime(time);
                    tr.gainNode.gain.exponentialRampToValueAtTime(0.0001, time + 0.005);
                    tr.activeSource.stop(time + 0.005);
                }
                
                const src = this.ctx.createBufferSource();
                const g = this.ctx.createGain();
                src.buffer = tr.buffer;
                src.connect(g);
                g.connect(channel.input);
                src.start(time);
                tr.activeSource = src;
                tr.gainNode = g;
            }
        });
        requestAnimationFrame(() => ui.updatePlayhead(s));
    },
    stopAll() {
        clearTimeout(this.timer);
        if(recorder.recording) recorder.stop();
        this.step = 0; this.songIdx = 0;
        this.tracks.forEach(t => {
            if(t.activeSource && t.gainNode) {
                t.gainNode.gain.cancelAndHoldAtTime(this.ctx.currentTime);
                t.gainNode.gain.exponentialRampToValueAtTime(0.0001, this.ctx.currentTime + 0.05);
                t.activeSource.stop(this.ctx.currentTime + 0.05);
            }
        });
        ui.render(); ui.updatePlayhead(0);
    },
    rebuildChain(chIdx) {
        const ch = this.mixer[chIdx];
        ch.input.disconnect(); ch.fx.forEach(f => { if(f.output) f.output.disconnect(); });
        let prev = ch.input;
        if (ch.fx.length > 0) {
            ch.fx.forEach(f => { if (f.input && f.output) { prev.connect(f.input); prev = f.output; } });
        }
        prev.connect(ch.output);
    },
    async injectFX(chIdx, file, codeOverride = null) {
        this.initChannels();
        try {
            const code = codeOverride || await file.text();
            const blob = new Blob([code], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            const mod = await import(url + '#' + Date.now());
            const instance = new (mod.default || Object.values(mod)[0])(this.ctx);
            instance._sourceCode = code;
            this.mixer[chIdx].fx.push(instance);
            this.rebuildChain(chIdx);
            ui.renderMixer();
        } catch (err) { console.error("FX Load Error:", err); }
    },
    removeFX(chIdx, fxIdx) { this.mixer[chIdx].fx.splice(fxIdx, 1); this.rebuildChain(chIdx); ui.renderMixer(); },
    addTrack() {
        this.tracks.push({ 
            id: Date.now()+Math.random(), buffer: null, fileName: "EMPTY", bus: 0, activeSource: null, gainNode: null,
            patterns: Array.from({length:8}, () => Array(32).fill(false)) 
        });
        ui.render();
    },
    addSongCell() { this.song.push(0); ui.render(); },
    removeSongCell() { if(this.song.length > 1) { this.song.pop(); ui.render(); } },
    updateBankLength(dir) {
        let val = this.bankLengths[this.bank] + (dir * 4);
        this.bankLengths[this.bank] = Math.max(4, Math.min(32, val));
        ui.render();
    }
};

const ui = {
    mode: 'pattern',
    tab(name) {
        engine.initChannels();
        document.getElementById('page-seq').style.display = name === 'seq' ? 'block' : 'none';
        document.getElementById('page-mix').style.display = name === 'mix' ? 'block' : 'none';
        document.getElementById('tSeq').className = name === 'seq' ? 'active' : '';
        document.getElementById('tMix').className = name === 'mix' ? 'active' : '';
        if(name === 'mix') this.renderMixer();
    },
    toggleMode() {
        this.mode = (this.mode === 'pattern') ? 'song' : 'pattern';
        document.getElementById('modeBtn').innerText = this.mode === 'pattern' ? 'PAT' : 'SONG';
        this.render();
    },
    render() {
        const b = (this.mode === 'song') ? engine.song[engine.songIdx] : engine.bank;
        const list = document.getElementById('tracks-list'); if(!list) return;
        document.getElementById('bank-len-disp').innerText = `PAT ${b+1} LEN: ${engine.bankLengths[b]}`;
        list.innerHTML = '';
        const ph = document.getElementById('playhead-grid'); ph.innerHTML = '';
        for(let i=0; i<32; i++) ph.innerHTML += `<div class="playhead-slot"></div>`;
        
        engine.tracks.forEach((t, i) => {
            const row = document.createElement('div'); row.className = 'track-row';
            row.innerHTML = `
                <div><button onclick="this.nextElementSibling.click()">LOAD</button><input type="file" style="display:none" onchange="ui.loadSmp(${t.id}, this)"><div class="data-font" style="font-size:8px; margin-top:2px;">${t.fileName}</div></div>
                <div class="step-grid" id="grid-${t.id}"></div>
                <select class="data-font" onchange="engine.tracks[${i}].bus=this.value; engine.rebuildChain(this.value)">
                    ${engine.mixer.map((_,m)=>`<option value="${m}" ${t.bus==m?'selected':''}>CH ${m+1}</option>`).join('')}
                </select>
                <button onclick="engine.tracks.splice(${i},1);ui.render()">X</button>`;
            list.appendChild(row);
            const grid = document.getElementById(`grid-${t.id}`);
            for(let s=0; s<32; s++) {
                const step = document.createElement('div');
                step.className = `step ${t.patterns[b][s] ? 'on' : ''} ${s % 4 === 0 ? 'beat-mark' : ''}`;
                step.style.opacity = s >= engine.bankLengths[b] ? "0.1" : "1";
                step.onclick = () => { if(s < engine.bankLengths[b]) { t.patterns[b][s] = !t.patterns[b][s]; step.classList.toggle('on'); } };
                grid.appendChild(step);
            }
        });
        this.renderBanks(); this.renderSong();
    },
    renderMixer() {
        const rack = document.getElementById('mixer-rack'); if(!rack) return;
        rack.innerHTML = '';
        engine.mixer.forEach((ch, i) => {
            const strip = document.createElement('div'); strip.className = 'mixer-strip';
            strip.innerHTML = `<div class="data-font" style="text-align:center; padding-bottom:5px; border-bottom:1px solid #333">CH ${i+1}</div><div class="fx-stack"></div><button onclick="this.nextElementSibling.click()">+ FX</button><input type="file" style="display:none" onchange="engine.injectFX(${i}, this.files[0])"><div class="data-font" style="margin-top:10px">VOL</div><input type="range" min="0" max="1.5" step="0.01" value="${ch.output.gain.value}" oninput="engine.mixer[${i}].output.gain.value=this.value">`;
            rack.appendChild(strip);
            const stack = strip.querySelector('.fx-stack');
            ch.fx.forEach((fx, idx) => {
                const box = document.createElement('div'); box.style.border = "1px solid #444"; box.style.marginBottom="5px"; box.style.background="#000";
                if(fx.renderUI) fx.renderUI(box, () => engine.removeFX(i, idx));
                stack.appendChild(box);
            });
        });
    },
    async loadSmp(id, el) {
        engine.initChannels();
        const tr = engine.tracks.find(t => t.id === id);
        const file = el.files[0]; if(!file) return;
        tr.fileName = file.name.substring(0, 10);
        const arrayBuffer = await file.arrayBuffer();
        tr.buffer = await engine.ctx.decodeAudioData(arrayBuffer);
        ui.render();
    },
    updatePlayhead(s) {
        const ph = document.getElementById('playhead-grid');
        if(ph && ph.children[s]) {
            Array.from(ph.children).forEach(c => c.classList.remove('active'));
            ph.children[s].classList.add('active');
        }
    },
    renderBanks() {
        const nav = document.getElementById('bank-nav'); if(!nav) return;
        nav.innerHTML = '';
        const currentActiveBank = (this.mode === 'song') ? engine.song[engine.songIdx] : engine.bank;
        for(let i=0; i<8; i++) {
            const btn = document.createElement('button'); btn.innerText = i+1;
            btn.className = (currentActiveBank === i) ? 'active' : '';
            btn.onclick = () => { this.mode = 'pattern'; engine.bank = i; this.render(); };
            nav.appendChild(btn);
        }
    },
    renderSong() {
        const container = document.getElementById('song-cells'); if(!container) return; 
        container.innerHTML = '';
        engine.song.forEach((bank, idx) => {
            const cell = document.createElement('button'); cell.innerText = bank + 1;
            if(this.mode === 'song' && engine.songIdx === idx) cell.classList.add('active');
            cell.onclick = () => { engine.song[idx] = (engine.song[idx] + 1) % 8; ui.renderSong(); };
            container.appendChild(cell);
        });
    }
};
const io = {
    async exportSession() {
        const zip = new JSZip();
        const data = {
            bpm: engine.bpm, bankLengths: engine.bankLengths, song: engine.song, swing: engine.swing,
            tracks: engine.tracks.map(t => ({ id: t.id, bus: t.bus, patterns: t.patterns, fileName: t.fileName })),
            mixer: engine.mixer.map(m => ({ gain: m.output.gain.value, fxCodes: m.fx.map(f => f._sourceCode) }))
        };
        zip.file("project.json", JSON.stringify(data));
        const blob = await zip.generateAsync({type:"blob"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "session.daw"; a.click();
    },
    async importSession(el) {
        if(!el.files[0]) return;
        const zip = await JSZip.loadAsync(el.files[0]);
        const data = JSON.parse(await zip.file("project.json").async("string"));
        engine.bpm = data.bpm; engine.bankLengths = data.bankLengths; engine.song = data.song;
        engine.swing = data.swing || 0;
        engine.tracks = data.tracks.map(t => ({ ...t, buffer: null }));
        engine.mixer.forEach(async (m, i) => {
            m.output.gain.value = data.mixer[i].gain;
            m.fx = [];
            if(data.mixer[i].fxCodes) {
                for(const code of data.mixer[i].fxCodes) await engine.injectFX(i, null, code);
            }
        });
        ui.render();
    }
};
engine.addTrack();
ui.render();
</script>
</body>
</html>
